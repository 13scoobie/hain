'use strict';

var _ = require('lodash');

function fuzzyMatchFallback(elem, keyword, testStr, fuzzyScore) {
  var srcStr = keyword;
  var score = fuzzyScore * 0.5;
  for (var i = 0; i < testStr.length; ++i) {
    var chr = testStr.charAt(i);
    var occurIndex = srcStr.indexOf(chr);
    if (occurIndex < 0) {
      score = 0;
      break;
    }
    score++;
    srcStr = srcStr.substring(0, occurIndex) + srcStr.substring(occurIndex + 1);
  }
  if (srcStr.length > 0) score /= srcStr.length;
  score *= 0.1;
  return { elem: elem, matches: [], score: score, length: srcStr.length };
}

function fuzzyMatch(elem, testStr, keywordGetter) {
  var srcStr = keywordGetter(elem).toLowerCase();

  var maxLength = 15;
  var maxScore = (maxLength + maxLength * maxLength) * 0.5;
  var fuzzyScore = 0;
  var pattern_i = testStr.length - 1;
  var add = 1;
  var matches = [];

  for (var i = srcStr.length - 1; i >= 0; --i) {
    var srcChr = srcStr.charAt(i);
    var srcChrCode = srcStr.charCodeAt(i);
    var testChrCode = testStr.charCodeAt(pattern_i);
    if (pattern_i < 0 || srcChrCode !== testChrCode) {
      add *= 0.5;
      continue;
    }
    pattern_i--;
    add += 1;
    fuzzyScore += add;
    matches.push(i);
  }

  fuzzyScore = Math.min(maxScore, fuzzyScore);
  fuzzyScore /= maxScore;

  var success = pattern_i < 0;
  if (success) {
    return { elem: elem, matches: matches.reverse(), score: fuzzyScore, length: srcStr.length };
  }
  return fuzzyMatchFallback(elem, srcStr, testStr, fuzzyScore);
}

function headMatch(elem, testStr, keywordGetter) {
  var srcStr = keywordGetter(elem);
  var testLength = Math.min(srcStr.length, testStr.length);
  var matches = [];
  for (var i = 0; i < testLength; ++i) {
    if (srcStr.charCodeAt(i) !== testStr.charCodeAt(i)) {
      return { elem: elem, matches: [], score: 0 };
    }
    matches.push(i);
  }
  return { elem: elem, matches: matches, score: 1 };
}

function search(elems, testStr, keywordGetter, matchFunc) {
  var results = [];

  if (testStr === null || testStr === undefined || testStr.length === 0) {
    return results;
  }

  var testStr_norm = testStr.toLowerCase();
  if (_.isArray(elems)) {
    // array
    for (var i = 0; i < elems.length; ++i) {
      var matchResult = matchFunc(elems[i], testStr_norm, keywordGetter);
      if (matchResult.score === 0) continue;
      results.push(matchResult);
    }
  } else if (_.isObject(elems)) {
    // object like { [], [], [], ... }
    for (var prop in elems) {
      var arr = elems[prop];
      for (var _i = 0; _i < arr.length; ++_i) {
        var _matchResult = matchFunc(arr[_i], testStr_norm, keywordGetter);
        if (_matchResult.score === 0) continue;
        results.push(_matchResult);
      }
    }
  } else {
    // can't process
    return results;
  }
  return _.orderBy(results, ['score', 'length'], ['desc', 'asc']); // stable sort
}

function fuzzy(elems, testStr, keywordGetter) {
  return search(elems, testStr, keywordGetter, fuzzyMatch);
}

function head(elems, testStr, keywordGetter) {
  return search(elems, testStr, keywordGetter, headMatch);
}

function makeStringBoldHtml(str, boldIndices) {
  if (boldIndices === null || boldIndices.length === 0) {
    return str;
  }
  var p = '';
  var b_i = 0;
  for (var i = 0; i < str.length; ++i) {
    if (i === boldIndices[b_i]) {
      p += '<b>' + str.charAt(i) + '</b>';
      b_i++;
    } else {
      p += str.charAt(i);
    }
  }
  return p;
}

module.exports = {
  fuzzy: fuzzy,
  head: head,
  makeStringBoldHtml: makeStringBoldHtml
};
//# sourceMappingURL=data:application/json;base64,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SUFBd0IsWUFBWSxNQUFaLEtBQXVCLENBQXZCLEVBQTBCO0FBQ3BELFdBQU8sR0FBUCxDQURvRDtHQUF0RDtBQUdBLE1BQUksSUFBSSxFQUFKLENBSndDO0FBSzVDLE1BQUksTUFBTSxDQUFOLENBTHdDO0FBTTVDLE9BQUssSUFBSSxJQUFJLENBQUosRUFBTyxJQUFJLElBQUksTUFBSixFQUFZLEVBQUUsQ0FBRixFQUFLO0FBQ25DLFFBQUksTUFBTSxZQUFZLEdBQVosQ0FBTixFQUF3QjtBQUMxQixtQkFBVyxJQUFJLE1BQUosQ0FBVyxDQUFYLFVBQVgsQ0FEMEI7QUFFMUIsWUFGMEI7S0FBNUIsTUFHTztBQUNMLFdBQUssSUFBSSxNQUFKLENBQVcsQ0FBWCxDQUFMLENBREs7S0FIUDtHQURGO0FBUUEsU0FBTyxDQUFQLENBZDRDO0NBQTlDOztBQWlCQSxPQUFPLE9BQVAsR0FBaUI7QUFDZixTQUFPLEtBQVA7QUFDQSxRQUFNLElBQU47QUFDQSxzQkFBb0Isa0JBQXBCO0NBSEYiLCJmaWxlIjoidXRpbHMvbWF0Y2h1dGlsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xyXG5cclxuY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xyXG5cclxuZnVuY3Rpb24gZnV6enlNYXRjaEZhbGxiYWNrKGVsZW0sIGtleXdvcmQsIHRlc3RTdHIsIGZ1enp5U2NvcmUpIHtcclxuICBsZXQgc3JjU3RyID0ga2V5d29yZDtcclxuICBsZXQgc2NvcmUgPSBmdXp6eVNjb3JlICogMC41O1xyXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgdGVzdFN0ci5sZW5ndGg7ICsraSkge1xyXG4gICAgY29uc3QgY2hyID0gdGVzdFN0ci5jaGFyQXQoaSk7XHJcbiAgICBjb25zdCBvY2N1ckluZGV4ID0gc3JjU3RyLmluZGV4T2YoY2hyKTtcclxuICAgIGlmIChvY2N1ckluZGV4IDwgMCkge1xyXG4gICAgICBzY29yZSA9IDA7XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG4gICAgc2NvcmUrKztcclxuICAgIHNyY1N0ciA9IHNyY1N0ci5zdWJzdHJpbmcoMCwgb2NjdXJJbmRleCkgKyBzcmNTdHIuc3Vic3RyaW5nKG9jY3VySW5kZXggKyAxKTtcclxuICB9XHJcbiAgaWYgKHNyY1N0ci5sZW5ndGggPiAwKVxyXG4gICAgc2NvcmUgLz0gc3JjU3RyLmxlbmd0aDtcclxuICBzY29yZSAqPSAwLjE7XHJcbiAgcmV0dXJuIHsgZWxlbSwgbWF0Y2hlczogW10sIHNjb3JlLCBsZW5ndGg6IHNyY1N0ci5sZW5ndGggfTtcclxufVxyXG5cclxuZnVuY3Rpb24gZnV6enlNYXRjaChlbGVtLCB0ZXN0U3RyLCBrZXl3b3JkR2V0dGVyKSB7XHJcbiAgY29uc3Qgc3JjU3RyID0ga2V5d29yZEdldHRlcihlbGVtKS50b0xvd2VyQ2FzZSgpO1xyXG5cclxuICBjb25zdCBtYXhMZW5ndGggPSAxNTtcclxuICBjb25zdCBtYXhTY29yZSA9IChtYXhMZW5ndGggKyBtYXhMZW5ndGggKiBtYXhMZW5ndGgpICogMC41O1xyXG4gIGxldCBmdXp6eVNjb3JlID0gMDtcclxuICBsZXQgcGF0dGVybl9pID0gdGVzdFN0ci5sZW5ndGggLSAxO1xyXG4gIGxldCBhZGQgPSAxO1xyXG4gIGNvbnN0IG1hdGNoZXMgPSBbXTtcclxuXHJcbiAgZm9yIChsZXQgaSA9IHNyY1N0ci5sZW5ndGggLSAxOyBpID49IDA7IC0taSkge1xyXG4gICAgY29uc3Qgc3JjQ2hyID0gc3JjU3RyLmNoYXJBdChpKTtcclxuICAgIGNvbnN0IHNyY0NockNvZGUgPSBzcmNTdHIuY2hhckNvZGVBdChpKTtcclxuICAgIGNvbnN0IHRlc3RDaHJDb2RlID0gdGVzdFN0ci5jaGFyQ29kZUF0KHBhdHRlcm5faSk7XHJcbiAgICBpZiAocGF0dGVybl9pIDwgMCB8fCBzcmNDaHJDb2RlICE9PSB0ZXN0Q2hyQ29kZSkge1xyXG4gICAgICBhZGQgKj0gMC41O1xyXG4gICAgICBjb250aW51ZTtcclxuICAgIH1cclxuICAgIHBhdHRlcm5faS0tO1xyXG4gICAgYWRkICs9IDE7XHJcbiAgICBmdXp6eVNjb3JlICs9IGFkZDtcclxuICAgIG1hdGNoZXMucHVzaChpKTtcclxuICB9XHJcblxyXG4gIGZ1enp5U2NvcmUgPSBNYXRoLm1pbihtYXhTY29yZSwgZnV6enlTY29yZSk7XHJcbiAgZnV6enlTY29yZSAvPSBtYXhTY29yZTtcclxuXHJcbiAgY29uc3Qgc3VjY2VzcyA9IChwYXR0ZXJuX2kgPCAwKTtcclxuICBpZiAoc3VjY2Vzcykge1xyXG4gICAgcmV0dXJuIHsgZWxlbSwgbWF0Y2hlczogbWF0Y2hlcy5yZXZlcnNlKCksIHNjb3JlOiBmdXp6eVNjb3JlLCBsZW5ndGg6IHNyY1N0ci5sZW5ndGggfTtcclxuICB9XHJcbiAgcmV0dXJuIGZ1enp5TWF0Y2hGYWxsYmFjayhlbGVtLCBzcmNTdHIsIHRlc3RTdHIsIGZ1enp5U2NvcmUpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBoZWFkTWF0Y2goZWxlbSwgdGVzdFN0ciwga2V5d29yZEdldHRlcikge1xyXG4gIGNvbnN0IHNyY1N0ciA9IGtleXdvcmRHZXR0ZXIoZWxlbSk7XHJcbiAgY29uc3QgdGVzdExlbmd0aCA9IE1hdGgubWluKHNyY1N0ci5sZW5ndGgsIHRlc3RTdHIubGVuZ3RoKTtcclxuICBjb25zdCBtYXRjaGVzID0gW107XHJcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0ZXN0TGVuZ3RoOyArK2kpIHtcclxuICAgIGlmIChzcmNTdHIuY2hhckNvZGVBdChpKSAhPT0gdGVzdFN0ci5jaGFyQ29kZUF0KGkpKSB7XHJcbiAgICAgIHJldHVybiB7IGVsZW06IGVsZW0sIG1hdGNoZXM6IFtdLCBzY29yZTogMCB9O1xyXG4gICAgfVxyXG4gICAgbWF0Y2hlcy5wdXNoKGkpO1xyXG4gIH1cclxuICByZXR1cm4geyBlbGVtOiBlbGVtLCBtYXRjaGVzOiBtYXRjaGVzLCBzY29yZTogMSB9O1xyXG59XHJcblxyXG5mdW5jdGlvbiBzZWFyY2goZWxlbXMsIHRlc3RTdHIsIGtleXdvcmRHZXR0ZXIsIG1hdGNoRnVuYykge1xyXG4gIGNvbnN0IHJlc3VsdHMgPSBbXTtcclxuXHJcbiAgaWYgKHRlc3RTdHIgPT09IG51bGwgfHwgdGVzdFN0ciA9PT0gdW5kZWZpbmVkIHx8IHRlc3RTdHIubGVuZ3RoID09PSAwKSB7XHJcbiAgICByZXR1cm4gcmVzdWx0cztcclxuICB9XHJcblxyXG4gIGNvbnN0IHRlc3RTdHJfbm9ybSA9IHRlc3RTdHIudG9Mb3dlckNhc2UoKTtcclxuICBpZiAoXy5pc0FycmF5KGVsZW1zKSkge1xyXG4gICAgLy8gYXJyYXlcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZWxlbXMubGVuZ3RoOyArK2kpIHtcclxuICAgICAgY29uc3QgbWF0Y2hSZXN1bHQgPSBtYXRjaEZ1bmMoZWxlbXNbaV0sIHRlc3RTdHJfbm9ybSwga2V5d29yZEdldHRlcik7XHJcbiAgICAgIGlmIChtYXRjaFJlc3VsdC5zY29yZSA9PT0gMCkgY29udGludWU7XHJcbiAgICAgIHJlc3VsdHMucHVzaChtYXRjaFJlc3VsdCk7XHJcbiAgICB9XHJcbiAgfSBlbHNlIGlmIChfLmlzT2JqZWN0KGVsZW1zKSkge1xyXG4gICAgLy8gb2JqZWN0IGxpa2UgeyBbXSwgW10sIFtdLCAuLi4gfVxyXG4gICAgZm9yIChjb25zdCBwcm9wIGluIGVsZW1zKSB7XHJcbiAgICAgIGNvbnN0IGFyciA9IGVsZW1zW3Byb3BdO1xyXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyci5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgIGNvbnN0IG1hdGNoUmVzdWx0ID0gbWF0Y2hGdW5jKGFycltpXSwgdGVzdFN0cl9ub3JtLCBrZXl3b3JkR2V0dGVyKTtcclxuICAgICAgICBpZiAobWF0Y2hSZXN1bHQuc2NvcmUgPT09IDApIGNvbnRpbnVlO1xyXG4gICAgICAgIHJlc3VsdHMucHVzaChtYXRjaFJlc3VsdCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9IGVsc2Uge1xyXG4gICAgLy8gY2FuJ3QgcHJvY2Vzc1xyXG4gICAgcmV0dXJuIHJlc3VsdHM7XHJcbiAgfVxyXG4gIHJldHVybiBfLm9yZGVyQnkocmVzdWx0cywgWydzY29yZScsICdsZW5ndGgnXSwgWydkZXNjJywgJ2FzYyddKTsgLy8gc3RhYmxlIHNvcnRcclxufVxyXG5cclxuZnVuY3Rpb24gZnV6enkoZWxlbXMsIHRlc3RTdHIsIGtleXdvcmRHZXR0ZXIpIHtcclxuICByZXR1cm4gc2VhcmNoKGVsZW1zLCB0ZXN0U3RyLCBrZXl3b3JkR2V0dGVyLCBmdXp6eU1hdGNoKTtcclxufVxyXG5cclxuZnVuY3Rpb24gaGVhZChlbGVtcywgdGVzdFN0ciwga2V5d29yZEdldHRlcikge1xyXG4gIHJldHVybiBzZWFyY2goZWxlbXMsIHRlc3RTdHIsIGtleXdvcmRHZXR0ZXIsIGhlYWRNYXRjaCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG1ha2VTdHJpbmdCb2xkSHRtbChzdHIsIGJvbGRJbmRpY2VzKSB7XHJcbiAgaWYgKGJvbGRJbmRpY2VzID09PSBudWxsIHx8IGJvbGRJbmRpY2VzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgcmV0dXJuIHN0cjtcclxuICB9XHJcbiAgbGV0IHAgPSAnJztcclxuICBsZXQgYl9pID0gMDtcclxuICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ci5sZW5ndGg7ICsraSkge1xyXG4gICAgaWYgKGkgPT09IGJvbGRJbmRpY2VzW2JfaV0pIHtcclxuICAgICAgcCArPSBgPGI+JHtzdHIuY2hhckF0KGkpIH08L2I+YDtcclxuICAgICAgYl9pKys7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBwICs9IHN0ci5jaGFyQXQoaSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHJldHVybiBwO1xyXG59XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICBmdXp6eTogZnV6enksXHJcbiAgaGVhZDogaGVhZCxcclxuICBtYWtlU3RyaW5nQm9sZEh0bWw6IG1ha2VTdHJpbmdCb2xkSHRtbFxyXG59O1xyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
